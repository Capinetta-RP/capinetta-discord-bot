<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Capi Netta | Configuraci√≥n</title>
    <link rel="stylesheet" href="/<%= cssFile %>?v=<%= Date.now() %>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>

    <%- include('partials/sidebar') %>

        <div class="user-info">
            <% if (user.avatar) { %>
                <img src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.png" class="user-avatar"
                    alt="Avatar">
                <% } else { %>
                    <img src="https://cdn.discordapp.com/embed/avatars/0.png" class="user-avatar" alt="Avatar">
                    <% } %>
                        <div class="user-details">
                            <div class="username">
                                <%= user.username %>
                            </div>
                            <a href="/logout" class="logout-btn">Cerrar Sesi√≥n</a>
                        </div>
        </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <%- include('partials/server-selector') %>

                <div class="header-section">
                    <h1>‚öôÔ∏è Configuraci√≥n del Servidor</h1>
                    <p class="subtitle">Configura los canales y roles esenciales del bot Capi Netta</p>
                </div>

                <% if (success) { %>
                    <div class="alert alert-success">
                        ‚úÖ Configuraci√≥n guardada exitosamente
                    </div>
                    <% } %>

                        <% if (error) { %>
                            <div class="alert alert-error">
                                ‚ùå Error: <%= error %>
                            </div>
                            <% } %>

                                <form method="POST" action="/configuracion/save" class="config-form">

                                    <!-- Secci√≥n Canales -->
                                    <div class="config-section">
                                        <h2>üìç Canales del Servidor</h2>
                                        <p class="section-description">Configura los canales donde el bot enviar√°
                                            mensajes importantes</p>

                                        <div class="form-grid">
                                            <div class="form-group">
                                                <label for="logsChannel">üìú Canal de Logs</label>
                                                <select name="logsChannel" id="logsChannel">
                                                    <option value="">-- Sin configurar --</option>
                                                    <option value="CREATE">‚ú® Crear Nuevo</option>
                                                    <% channels.forEach(ch=> { %>
                                                        <option value="<%= ch.id %>" <%=settings.logsChannel===ch.id
                                                            ? 'selected' : '' %>>
                                                            #<%= ch.name %>
                                                        </option>
                                                        <% }); %>
                                                </select>
                                                <small>Logs de moderaci√≥n, mensajes eliminados, etc.</small>
                                            </div>

                                            <div class="form-group">
                                                <label for="debugChannel">üö® Canal de Debug</label>
                                                <select name="debugChannel" id="debugChannel">
                                                    <option value="">-- Sin configurar --</option>
                                                    <option value="CREATE">‚ú® Crear Nuevo</option>
                                                    <% channels.forEach(ch=> { %>
                                                        <option value="<%= ch.id %>" <%=settings.debugChannel===ch.id
                                                            ? 'selected' : '' %>>
                                                            #<%= ch.name %>
                                                        </option>
                                                        <% }); %>
                                                </select>
                                                <small>Errores t√©cnicos y mensajes del sistema</small>
                                            </div>

                                            <div class="form-group">
                                                <label for="verifyChannel">‚úÖ Canal de Verificaci√≥n</label>
                                                <select name="verifyChannel" id="verifyChannel">
                                                    <option value="">-- Sin configurar --</option>
                                                    <option value="CREATE">‚ú® Crear Nuevo</option>
                                                    <% channels.forEach(ch=> { %>
                                                        <option value="<%= ch.id %>" <%=settings.verifyChannel===ch.id
                                                            ? 'selected' : '' %>>
                                                            #<%= ch.name %>
                                                        </option>
                                                        <% }); %>
                                                </select>
                                                <small>Canal donde los usuarios se verifican</small>
                                            </div>

                                            <div class="form-group">
                                                <label for="welcomeChannel">üëã Canal de Bienvenida</label>
                                                <select name="welcomeChannel" id="welcomeChannel">
                                                    <option value="">-- Sin configurar --</option>
                                                    <option value="CREATE">‚ú® Crear Nuevo</option>
                                                    <% channels.forEach(ch=> { %>
                                                        <option value="<%= ch.id %>" <%=settings.welcomeChannel===ch.id
                                                            ? 'selected' : '' %>>
                                                            #<%= ch.name %>
                                                        </option>
                                                        <% }); %>
                                                </select>
                                                <small>Mensajes de bienvenida a nuevos miembros</small>
                                            </div>

                                            <div class="form-group">
                                                <label for="supportChannel">üÜò Canal de Soporte</label>
                                                <select name="supportChannel" id="supportChannel">
                                                    <option value="">-- Sin configurar --</option>
                                                    <option value="CREATE">‚ú® Crear Nuevo</option>
                                                    <% channels.forEach(ch=> { %>
                                                        <option value="<%= ch.id %>" <%=settings.supportChannel===ch.id
                                                            ? 'selected' : '' %>>
                                                            #<%= ch.name %>
                                                        </option>
                                                        <% }); %>
                                                </select>
                                                <small>Soporte/reportes de estafa</small>
                                            </div>

                                            <div class="form-group">
                                                <label for="ticketLogsChannel">üé´ Logs de Tickets</label>
                                                <select name="ticketLogsChannel" id="ticketLogsChannel">
                                                    <option value="">-- Sin configurar --</option>
                                                    <option value="CREATE">‚ú® Crear Nuevo</option>
                                                    <% channels.forEach(ch=> { %>
                                                        <option value="<%= ch.id %>"
                                                            <%=settings.ticketLogsChannel===ch.id ? 'selected' : '' %>>
                                                            #<%= ch.name %>
                                                        </option>
                                                        <% }); %>
                                                </select>
                                                <small>Transcripts y logs de tickets cerrados</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Secci√≥n Roles -->
                                    <div class="config-section">
                                        <h2>üëë Roles del Servidor</h2>
                                        <p class="section-description">Configura los roles autom√°ticos del sistema</p>

                                        <div class="form-grid">
                                            <div class="form-group">
                                                <label for="roleUser">üë§ Rol de Usuario Verificado</label>
                                                <select name="roleUser" id="roleUser">
                                                    <option value="">-- Sin configurar --</option>
                                                    <option value="CREATE">‚ú® Crear Nuevo</option>
                                                    <% roles.forEach(role=> { %>
                                                        <option value="<%= role.id %>" <%=settings.roleUser===role.id
                                                            ? 'selected' : '' %>>
                                                            @<%= role.name %>
                                                        </option>
                                                        <% }); %>
                                                </select>
                                                <small>Se otorga al verificarse</small>
                                            </div>

                                            <div class="form-group">
                                                <label for="roleNoVerify">‚ùì Rol Sin Verificar</label>
                                                <select name="roleNoVerify" id="roleNoVerify">
                                                    <option value="">-- Sin configurar --</option>
                                                    <option value="CREATE">‚ú® Crear Nuevo</option>
                                                    <% roles.forEach(role=> { %>
                                                        <option value="<%= role.id %>"
                                                            <%=settings.roleNoVerify===role.id ? 'selected' : '' %>>
                                                            @<%= role.name %>
                                                        </option>
                                                        <% }); %>
                                                </select>
                                                <small>Rol temporal para usuarios nuevos</small>
                                            </div>

                                            <div class="form-group">
                                                <label for="roleMuted">üîá Rol de Muteado</label>
                                                <select name="roleMuted" id="roleMuted">
                                                    <option value="">-- Sin configurar --</option>
                                                    <option value="CREATE">‚ú® Crear Nuevo</option>
                                                    <% roles.forEach(role=> { %>
                                                        <option value="<%= role.id %>" <%=settings.roleMuted===role.id
                                                            ? 'selected' : '' %>>
                                                            @<%= role.name %>
                                                        </option>
                                                        <% }); %>
                                                </select>
                                                <small>Rol para usuarios silenciados</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Secci√≥n Roles de Staff -->
                                    <div class="config-section">
                                        <h2>üëÆ Roles de Staff</h2>
                                        <p class="section-description">Selecciona los roles que se considerar√°n como
                                            Staff para estad√≠sticas y conteos</p>

                                        <div class="form-group-full">
                                            <label>Selecciona los roles de Staff (puedes elegir m√∫ltiples)</label>
                                            <div class="checkbox-group">
                                                <% const staffRolesArray=settings.staffRoles ?
                                                    JSON.parse(settings.staffRoles) : []; roles.forEach(role=> {
                                                    %>
                                                    <label class="checkbox-item">
                                                        <input type="checkbox" name="staffRoles" value="<%= role.id %>"
                                                            <%=staffRolesArray.includes(role.id) ? 'checked' : '' %>>
                                                        <span class="checkbox-label">@<%= role.name %></span>
                                                    </label>
                                                    <% }); %>
                                            </div>
                                            <small>Estos roles se usar√°n para contar Staff Online en el
                                                dashboard</small>
                                        </div>
                                    </div>

                                    <!-- Estado y Botones -->
                                    <div class="config-status">
                                        <div class="status-badge <%= settings.isSetup ? 'status-ok' : 'status-warn' %>">
                                            <%= settings.isSetup ? '‚úÖ Configuraci√≥n Completa'
                                                : '‚ö†Ô∏è Configuraci√≥n Incompleta' %>
                                        </div>
                                    </div>

                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary">üíæ Guardar Configuraci√≥n</button>
                                        <a href="/dashboard" class="btn btn-secondary">‚ùå Cancelar</a>
                                    </div>
                                </form>

        </main>

        <%- include('partials/sidebar-script') %>

            <script>
                // Auto-hide alerts
                setTimeout(() => {
                    const alerts = document.querySelectorAll('.alert');
                    alerts.forEach(alert => {
                        alert.style.opacity = '0';
                        setTimeout(() => alert.remove(), 300);
                    });
                }, 5000);
            </script>

</html>